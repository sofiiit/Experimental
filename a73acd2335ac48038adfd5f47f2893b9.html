<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>d4d2798a90904e99bb02ffecb6c718e1</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div id="c3b43ca7" class="cell code" data-execution_count="2">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install vorbin</span></span></code></pre></div>
</div>
<div id="910d3081" class="cell code">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpdaf.obj <span class="im">import</span> Cube</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spectral_cube <span class="im">import</span> SpectralCube</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> astropy.io <span class="im">import</span> fits</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> transforms</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> astropy.stats <span class="im">import</span> sigma_clip, mad_std</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gofish <span class="im">import</span> imagecube</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> astropy.units <span class="im">as</span> u</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> LogLocator, LogFormatter, ScalarFormatter, LogFormatterSciNotation</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> vorbin</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> vorbin.voronoi_2d_binning <span class="im">import</span> voronoi_2d_binning</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> curve_fit</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> astropy.visualization <span class="im">import</span> AsinhStretch, ImageNormalize</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> astropy.visualization <span class="im">import</span> simple_norm</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> astropy.cosmology <span class="im">import</span> Planck18 <span class="im">as</span> cosmo</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> extinction</span></code></pre></div>
</div>
<div id="4a6a8006" class="cell code">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> transforms</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> ScalarFormatter</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> astropy.units <span class="im">as</span> u</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spectral_cube <span class="im">import</span> SpectralCube</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> astropy.io <span class="im">import</span> fits</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> astropy.wcs <span class="im">import</span> WCS</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> ScalarFormatter</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
</div>
<div id="65abf7f8" class="cell code" data-execution_count="2">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>hdu <span class="op">=</span> fits.<span class="bu">open</span>(<span class="st">&quot;teacup.fits&quot;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>hdu.info()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">repr</span>(hdu[<span class="dv">1</span>].header))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Filename: teacup.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU    1546   ()      
  1  DATA          1 ImageHDU        43   (322, 318, 3802)   float32   
  2  STAT          1 ImageHDU        43   (322, 318, 3802)   float32   
XTENSION= &#39;IMAGE   &#39;           / IMAGE extension                                
BITPIX  =                  -32 / number of bits per data pixel                  
NAXIS   =                    3 / number of data axes                            
NAXIS1  =                  322 / length of data axis 1                          
NAXIS2  =                  318 / length of data axis 2                          
NAXIS3  =                 3802 / length of data axis 3                          
PCOUNT  =                    0 / required keyword; must = 0                     
GCOUNT  =                    1 / required keyword; must = 1                     
EXTNAME = &#39;DATA    &#39;           / This extension contains data values            
DATASUM = &#39;1605300420&#39;         / data unit checksum updated 2020-03-10T12:23:59 
HDUCLASS= &#39;ESO     &#39;           / class name (ESO format)                        
HDUDOC  = &#39;DICD    &#39;           / document with class description                
HDUVERS = &#39;DICD version 6&#39;     / version number (according to spec v2.5.1)      
HDUCLAS1= &#39;IMAGE   &#39;           / Image data format                              
HDUCLAS2= &#39;DATA    &#39;           / this extension contains the data itself        
ERRDATA = &#39;STAT    &#39;           / pointer to the variance extension              
OBJECT  = &#39;Teacup (DATA)&#39;                                                       
BUNIT   = &#39;10**(-20)*erg/s/cm**2/Angstrom&#39;                                      
CRPIX1  =     163.938487646673 / Pixel coordinate of reference point            
CRPIX2  =     155.344040098697 / Pixel coordinate of reference point            
CD1_1   = -5.55555555555556E-05 / Coordinate transformation matrix element      
CD1_2   =                   0. / Coordinate transformation matrix element       
CD2_1   =                   0. / Coordinate transformation matrix element       
CD2_2   = 5.55555555555556E-05 / Coordinate transformation matrix element       
CUNIT1  = &#39;deg     &#39;           / Units of coordinate increment and value        
CUNIT2  = &#39;deg     &#39;           / Units of coordinate increment and value        
CTYPE1  = &#39;RA---TAN&#39;           / Right ascension, gnomonic projection           
CTYPE2  = &#39;DEC--TAN&#39;           / Declination, gnomonic projection               
CSYER1  =     1.3680091695E-05 / [deg] Systematic error in coordinate           
CSYER2  =    7.77995869722E-06 / [deg] Systematic error in coordinate           
CRVAL1  =           217.624397                                                  
CRVAL2  =             13.65424                                                  
CTYPE3  = &#39;AWAV    &#39;                                                            
CUNIT3  = &#39;Angstrom&#39;                                                            
CD3_3   =                 1.25                                                  
CRPIX3  =                   1.                                                  
CRVAL3  =     4600.28173828125                                                  
CRDER3  =                0.026 / [Angstrom] Random error in spectral coordinate 
CD1_3   =                   0.                                                  
CD2_3   =                   0.                                                  
CD3_1   =                   0.                                                  
CD3_2   =                   0.                                                  
TITLE   = &#39;Teacup_2081147_2019-03-03T08:07:29.370_WFM-NOAO-E_OBJ&#39;               
</code></pre>
</div>
</div>
<div id="447c66f8" class="cell code" data-execution_count="3">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cube <span class="op">=</span> hdu[<span class="dv">1</span>].data </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>header <span class="op">=</span> hdu[<span class="dv">1</span>].header</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cube.shape)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>(3802, 318, 322)
</code></pre>
</div>
</div>
<div id="5a92c4ef" class="cell code" data-execution_count="4">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&quot;teacup.fits-Z-profile-galax_true.tsv&quot;</span>,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                 sep<span class="op">=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>)</span></code></pre></div>
</div>
<div id="2de1319f" class="cell code">
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>), constrained_layout<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>ax.plot(df[<span class="st">&quot;x&quot;</span>], df[<span class="st">&quot;y&quot;</span>], color<span class="op">=</span><span class="st">&#39;black&#39;</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="vs">r&#39;Longitud de Onda [Å]&#39;</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>       ylabel<span class="op">=</span><span class="vs">r&#39;Flujo&#39;</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>       xlim<span class="op">=</span>(df[<span class="st">&quot;x&quot;</span>].<span class="bu">min</span>(), <span class="dv">7500</span>))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>trans <span class="op">=</span> transforms.blended_transform_factory(ax.transData, ax.transAxes)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> vline_outside(ax, x, label, color<span class="op">=</span><span class="st">&#39;orchid&#39;</span>, dy_axes<span class="op">=</span><span class="fl">0.01</span>, rot<span class="op">=</span><span class="dv">90</span>):</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    ax.axvline(x<span class="op">=</span>x, color<span class="op">=</span>color, ls<span class="op">=</span><span class="st">&#39;--&#39;</span>, lw<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    ax.text(x, <span class="fl">1.0</span> <span class="op">+</span> dy_axes, label,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>            transform<span class="op">=</span>trans, rotation<span class="op">=</span>rot,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">&#39;center&#39;</span>, va<span class="op">=</span><span class="st">&#39;bottom&#39;</span>, clip_on<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Líneas de emisión </span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>vline_outside(ax, <span class="dv">4711</span>, <span class="st">&#39;He II&#39;</span>, )</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>vline_outside(ax, <span class="dv">5278</span>, <span class="st">&#39;Hβ&#39;</span>,    )</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>vline_outside(ax, <span class="dv">5384</span>, <span class="st">&#39;[O III]1&#39;</span>, )</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>vline_outside(ax, <span class="dv">5436</span>, <span class="st">&#39;[O III]2&#39;</span>, )</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>vline_outside(ax, <span class="dv">6838</span>, <span class="st">&#39;[O I]&#39;</span>, )</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>vline_outside(ax, <span class="dv">7123</span>, <span class="st">&#39;Hα&#39;</span>,    )</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>vline_outside(ax, <span class="dv">7147</span>, <span class="st">&#39;[N II]&#39;</span>, )</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>vline_outside(ax, <span class="dv">7293</span>, <span class="st">&#39;[S II]&#39;</span>, )</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_formatter(ScalarFormatter(useMathText<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>fig.subplots_adjust(top<span class="op">=</span><span class="fl">0.86</span>)     </span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/96b1b91f27f7f6b9ba33f16ad5567bccd16eaa22.png" /></p>
</div>
</div>
<div id="acfa072b" class="cell code" data-execution_count="6">
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>rest <span class="op">=</span> u.AA <span class="op">*</span> np.array([<span class="fl">4861.33</span>, <span class="fl">4958.91</span>, <span class="fl">5006.84</span>, <span class="fl">6300.30</span>, <span class="fl">6562.80</span>, <span class="fl">6583.45</span>, <span class="fl">6716.44</span>])</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>obs  <span class="op">=</span> u.AA <span class="op">*</span> np.array([<span class="fl">5278.00</span>, <span class="fl">5384.00</span>, <span class="fl">5436.00</span>, <span class="fl">6838.00</span>, <span class="fl">7123.00</span>, <span class="fl">7147.00</span>, <span class="fl">7293.00</span>])</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> (obs<span class="op">/</span>rest <span class="op">-</span> <span class="dv">1</span>).value</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>zc <span class="op">=</span> sigma_clip(z, sigma<span class="op">=</span><span class="dv">2</span>).compressed()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>z_med, z_err <span class="op">=</span> np.median(zc), mad_std(zc)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> np.vstack([rest.value, np.ones_like(rest.value)]).T</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>slope, offset <span class="op">=</span> np.linalg.lstsq(A, obs.value, rcond<span class="op">=</span><span class="va">None</span>)[<span class="dv">0</span>]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>z_fit <span class="op">=</span> slope <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;z = </span><span class="sc">{</span>z_med<span class="sc">:.5f}</span><span class="ss"> ± </span><span class="sc">{</span>z_err<span class="sc">:.5f}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>z = 0.08571 ± 0.00001
</code></pre>
</div>
</div>
<div id="60d033e1" class="cell code" data-execution_count="7">
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>cube <span class="op">=</span> Cube(filename<span class="op">=</span><span class="st">&#39;teacup.fits&#39;</span>,ext<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span></code></pre></div>
</div>
<div id="bf2ad2eb" class="cell code" data-execution_count="10">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cube[:,150,160].plot(unit=u.angstrom)</span></span></code></pre></div>
</div>
<div id="2490f14e" class="cell code" data-execution_count="8">
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cube[:,156,155].plot(unit=u.angstrom,lmin=5405,lmax=5460) # OIII</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># cube[:,156,155].plot(unit=u.angstrom,lmin=5005,lmax=6000)</span></span></code></pre></div>
</div>
<div id="9af1c9f3" class="cell code" data-execution_count="10">
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OIII = cube[:,156,155].gauss_fit(unit=u.angstrom,lmin=5405,lmax=5460, plot=True)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># OIII.print_param()</span></span></code></pre></div>
</div>
<div id="90443773" class="cell code" data-execution_count="11">
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 5278</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># cube[:,156,155].plot(unit=u.angstrom,lmin=5265,lmax=5290) # Hb</span></span></code></pre></div>
</div>
<div id="32d39ac1" class="cell code" data-execution_count="12">
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Hb = cube[:,156,155].gauss_fit(unit=u.angstrom,lmin=5265,lmax=5290, plot=True)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Hb.print_param()</span></span></code></pre></div>
</div>
<div id="d5b3a677" class="cell code" data-execution_count="13">
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cube[:,156,155].plot(unit=u.angstrom,lmin=7085,lmax=7170) # Ha y NII</span></span></code></pre></div>
</div>
<div id="2c49e3a7" class="cell markdown">
<h1 id="correcciones"><strong>Correcciones</strong></h1>
</div>
<div id="4d7e9ad7" class="cell markdown">
<h1 id="resta-del-continuo"><strong>Resta del Continuo</strong></h1>
</div>
<div id="a844c7e5" class="cell code">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cube_rest = SpectralCube.read(&#39;teacup.fits&#39;, hdu=1).with_spectral_unit(u.AA)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># lam  = cube_rest.spectral_axis.to_value(u.AA).astype(np.float32)</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># N, Ny, Nx = cube_rest.shape</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># m = (lam &gt;= 5708) &amp; (lam &lt;= 6758)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># k = int(m.sum())</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Xg = np.vstack([np.ones(k, dtype=np.float32), lam[m]]).T   # [k x 2]</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># X  = np.vstack([np.ones(N, dtype=np.float32), lam]).T      # [N x 2]</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># data_sub = np.empty((N, Ny, Nx), dtype=np.float32)</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ty, tx = 64, 64</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># for y0 in range(0, Ny, ty):</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     y1 = min(Ny, y0+ty)</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     for x0 in range(0, Nx, tx):</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">#         x1 = min(Nx, x0+tx)</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">#         blk = cube_rest.filled_data[:, y0:y1, x0:x1].value.astype(np.float32)</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">#         Dg = blk[m].reshape(k, -1)</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">#         ok = np.all(np.isfinite(Dg), axis=0)</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">#         cont_blk = np.full((N, Dg.shape[1]), np.nan, dtype=np.float32)</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co">#         if np.any(ok):</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co">#             coef, *_ = np.linalg.lstsq(Xg, Dg[:, ok], rcond=None)</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co">#             cont_blk[:, ok] = X @ coef</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co">#         sub_blk = blk.reshape(N, -1) - cont_blk</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co">#         data_sub[:, y0:y1, x0:x1] = sub_blk.reshape(N, y1-y0, x1-x0)</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co"># cube_sub = SpectralCube(data_sub * cube_rest.unit, wcs=cube_rest.wcs)</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="co"># cube_sub.write(&#39;teacup_continuum_sub.fits&#39;, overwrite=True)</span></span></code></pre></div>
</div>
<div id="646d48b9" class="cell code" data-execution_count="18">
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cube[:,156,150].plot(unit=u.angstrom,lmin=5000,lmax=7400)</span></span></code></pre></div>
</div>
<div id="8a549f99" class="cell code" data-execution_count="19">
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cubee = Cube(filename=&#39;teacup_continuum_sub.fits&#39;,ext=(1,2))</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># cubee[:,156,150].plot(unit=u.angstrom,lmin=5000,lmax=7400)</span></span></code></pre></div>
</div>
<div id="8513be1d" class="cell code">
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>cube2 <span class="op">=</span> SpectralCube.read(<span class="st">&quot;teacup_continuum_sub.fits&quot;</span>, hdu<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>wave <span class="op">=</span> cube2.spectral_axis.to(u.AA).value</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>nchan <span class="op">=</span> cube2.shape[<span class="dv">0</span>]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>do_sum <span class="op">=</span> <span class="va">False</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>flux <span class="op">=</span> np.empty(nchan, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>ny, nx <span class="op">=</span> cube2.shape[<span class="dv">1</span>], cube2.shape[<span class="dv">2</span>]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(nchan):</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    sli <span class="op">=</span> cube2.filled_data[i, :, :] </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    arr <span class="op">=</span> sli.value  </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> do_sum:</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        flux[i] <span class="op">=</span> np.nansum(arr)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        flux[i] <span class="op">=</span> np.nanmean(arr)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>), constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>ax.plot(wave, flux, color<span class="op">=</span><span class="st">&#39;black&#39;</span>, lw<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="vs">r&#39;Longitud de Onda [Å]&#39;</span>,</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span>(<span class="st">&#39;Flujo (suma)&#39;</span> <span class="cf">if</span> do_sum <span class="cf">else</span> <span class="st">&#39;Flujo&#39;</span>),</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    xlim<span class="op">=</span>(wave.<span class="bu">min</span>(), <span class="dv">7500</span>)  </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>trans <span class="op">=</span> transforms.blended_transform_factory(ax.transData, ax.transAxes)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> vline_outside(ax, x, label, color<span class="op">=</span><span class="st">&#39;orchid&#39;</span>, dy_axes<span class="op">=</span><span class="fl">0.01</span>, rot<span class="op">=</span><span class="dv">90</span>):</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    ax.axvline(x<span class="op">=</span>x, color<span class="op">=</span>color, ls<span class="op">=</span><span class="st">&#39;--&#39;</span>, lw<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    ax.text(x, <span class="fl">1.0</span> <span class="op">+</span> dy_axes, label, transform<span class="op">=</span>trans, rotation<span class="op">=</span>rot,</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>            ha<span class="op">=</span><span class="st">&#39;center&#39;</span>, va<span class="op">=</span><span class="st">&#39;bottom&#39;</span>, clip_on<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> <span class="fl">0.08571</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>rest <span class="op">=</span> {</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;He II&quot;</span>: <span class="fl">4685.7</span>,</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Hβ&quot;</span>: <span class="fl">4861.33</span>,</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;[O III]1&quot;</span>: <span class="fl">4958.92</span>,</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;[O III]2&quot;</span>: <span class="fl">5006.84</span>,</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;[O I]&quot;</span>: <span class="fl">6300.30</span>,</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Hα&quot;</span>: <span class="fl">6562.80</span>,</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;[N II]&quot;</span>: <span class="fl">6583.45</span>,</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;[S II]&quot;</span>: <span class="fl">6716.44</span>, </span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lab, lam0 <span class="kw">in</span> rest.items():</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>    vline_outside(ax, lam0<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>z), lab)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_formatter(ScalarFormatter(useMathText<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/27f3048664f560ad7b587ab9d3bd486352ca1f75.png" /></p>
</div>
</div>
<div id="d5bad389" class="cell markdown">
<h1 id="momentos"><strong>Momentos</strong></h1>
</div>
<div id="620e0ea0" class="cell code" data-execution_count="17">
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fits.<span class="bu">open</span>(<span class="st">&#39;teacup_continuum_sub.fits&#39;</span>).info()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Filename: teacup_continuum_sub.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU      31   (322, 318, 3802)   float32   
</code></pre>
</div>
</div>
<div id="a14d7d5d" class="cell code" data-execution_count="18">
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fits.<span class="bu">open</span>(<span class="st">&#39;teacup.fits&#39;</span>).info()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Filename: teacup.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU    1546   ()      
  1  DATA          1 ImageHDU        43   (322, 318, 3802)   float32   
  2  STAT          1 ImageHDU        43   (322, 318, 3802)   float32   
</code></pre>
</div>
</div>
<div id="c7c28ca1" class="cell code" data-execution_count="19">
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cube2 = SpectralCube.read(&#39;teacup_continuum_sub.fits&#39;,hdu=1)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>OIII_cube <span class="op">=</span> fits.<span class="bu">open</span>(<span class="st">&#39;teacup.fits&#39;</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>cube2_sn <span class="op">=</span> SpectralCube(data<span class="op">=</span>OIII_cube[<span class="dv">1</span>].data<span class="op">/</span>np.sqrt(OIII_cube[<span class="dv">2</span>].data),wcs<span class="op">=</span>cube2.wcs)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>cube2_masked <span class="op">=</span> cube2.with_mask(cube2_sn<span class="op">&gt;</span><span class="fl">3.5</span>)</span></code></pre></div>
</div>
<div id="77105fff" class="cell code" data-execution_count="20">
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>OIII_cube_masked <span class="op">=</span> cube2_masked.with_spectral_unit(u.km<span class="op">/</span>u.s,velocity_convention<span class="op">=</span><span class="st">&#39;optical&#39;</span>,rest_value<span class="op">=</span><span class="fl">5433.61</span><span class="op">*</span>u.AA)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>OIII_subcube_masked <span class="op">=</span> OIII_cube_masked.spectral_slab(<span class="op">-</span><span class="dv">600</span><span class="op">*</span>u.km<span class="op">/</span>u.s,<span class="dv">600</span><span class="op">*</span>u.km<span class="op">/</span>u.s)</span></code></pre></div>
</div>
<div id="ced3d90d" class="cell code" data-execution_count="53">
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> LogNorm</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> LogFormatterMathtext</span></code></pre></div>
</div>
<div id="f80936ac" class="cell code">
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>moment_0_masked <span class="op">=</span> OIII_subcube_masked.moment(order<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.subplot(projection<span class="op">=</span>cube2.wcs.celestial)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> moment_0_masked.value</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>vmin <span class="op">=</span> np.nanpercentile(data[data <span class="op">&gt;</span> <span class="dv">0</span>], <span class="dv">1</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>vmax <span class="op">=</span> np.nanpercentile(data, <span class="fl">99.9</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> ax.imshow(data, origin<span class="op">=</span><span class="st">&#39;lower&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;inferno&#39;</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>               norm<span class="op">=</span>LogNorm(vmin<span class="op">=</span>vmin, vmax<span class="op">=</span>vmax))</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar(im, ax<span class="op">=</span>ax, pad<span class="op">=</span><span class="fl">0.02</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>cbar.set_label(<span class="vs">r&#39;Intensidad [$\mathrm{erg\ s^{-1}\ cm^{-2</span><span class="sc">}}</span><span class="vs">$]&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="vs">r&#39;Ascensión Recta&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r&#39;Declinación&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="vs">r&#39;Momento 0 [O III]&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>ax.invert_xaxis()</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/7d2f434d75ae6d0f0d42d15d671305a6eec2f52a.png" /></p>
</div>
</div>
<div id="4cd4c162" class="cell code">
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>moment_1_masked <span class="op">=</span> OIII_subcube_masked.moment(order<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>wcs <span class="op">=</span> cube2.wcs.sub([<span class="st">&#39;longitude&#39;</span>, <span class="st">&#39;latitude&#39;</span>])</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>norm <span class="op">=</span> simple_norm(moment_1_masked.value, <span class="st">&#39;linear&#39;</span>, vmin<span class="op">=-</span><span class="dv">300</span>, vmax<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">5</span>))</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.subplot(projection<span class="op">=</span>wcs)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> ax.imshow(moment_1_masked.value, origin<span class="op">=</span><span class="st">&#39;lower&#39;</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>               cmap<span class="op">=</span><span class="st">&#39;coolwarm&#39;</span>, norm<span class="op">=</span>norm)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar(im, ax<span class="op">=</span>ax, pad<span class="op">=</span><span class="fl">0.02</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>cbar.ax.yaxis.set_major_formatter(ScalarFormatter(useMathText<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>cbar.ax.tick_params(labelsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>cbar.set_label(<span class="vs">r&quot;Velocidad [km\,s$^{-1}$]&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="vs">r&quot;Ascensión Recta&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r&quot;Declinación&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">&quot;Momento 1 [O III]&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>, pad<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>ax.coords[<span class="dv">0</span>].set_format_unit(<span class="st">&#39;hour&#39;</span>)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>ax.coords[<span class="dv">1</span>].set_format_unit(<span class="st">&#39;degree&#39;</span>)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>ax.coords.grid(color<span class="op">=</span><span class="st">&#39;gray&#39;</span>, ls<span class="op">=</span><span class="st">&#39;:&#39;</span>, lw<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/32de7fd0e50352e9556a6f6d21d5301535a30793.png" /></p>
</div>
</div>
<div id="c4fc52e8" class="cell code">
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>moment_2_masked <span class="op">=</span> OIII_subcube_masked.moment(order<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>sigma_map <span class="op">=</span> np.sqrt(moment_2_masked.value)  </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>wcs <span class="op">=</span> cube2.wcs.celestial</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>norm <span class="op">=</span> simple_norm(sigma_map, <span class="st">&#39;linear&#39;</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.subplot(projection<span class="op">=</span>wcs)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> ax.imshow(sigma_map, origin<span class="op">=</span><span class="st">&#39;lower&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;inferno&#39;</span>, norm<span class="op">=</span>norm)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar(im, ax<span class="op">=</span>ax, pad<span class="op">=</span><span class="fl">0.02</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>cbar.ax.yaxis.set_major_formatter(ScalarFormatter(useMathText<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>cbar.ax.tick_params(labelsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>cbar.set_label(<span class="vs">r&quot;Dispersión $ {\sigma}$ [km\,s$^{-1}$]&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="vs">r&quot;Ascensión Recta&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="vs">r&quot;Declinación&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="vs">r&quot;Momento 2 [O III] &quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>, pad<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>ax.invert_xaxis()</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>ax.coords.grid(color<span class="op">=</span><span class="st">&#39;gray&#39;</span>, ls<span class="op">=</span><span class="st">&#39;:&#39;</span>, lw<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/b706773a68fa9c6b05c746bc1b9df614580d1927.png" /></p>
</div>
</div>
<div id="d6c5d06b" class="cell code">
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> <span class="fl">0.08571</span>                          </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>half_line <span class="op">=</span> <span class="fl">10.0</span>                      </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>cont_win <span class="op">=</span> (<span class="fl">6000.0</span>, <span class="fl">6200.0</span>)        </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>cube_cont_path <span class="op">=</span> <span class="st">&quot;teacup.fits&quot;</span>                </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>cube_lines_path <span class="op">=</span> <span class="st">&quot;teacup_continuum_sub.fits&quot;</span> </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>hdu_idx <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>lam0_oiii <span class="op">=</span> <span class="fl">5006.84</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>lam0_ha   <span class="op">=</span> <span class="fl">6562.80</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>lam_oiii <span class="op">=</span> lam0_oiii <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">+</span> z)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>lam_ha   <span class="op">=</span> lam0_ha   <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">+</span> z)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> collapse_window_sum(cube, lam_center, half_width):</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> cube.spectral_axis.to(u.AA).value</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    sel <span class="op">=</span> (w <span class="op">&gt;=</span> lam_center <span class="op">-</span> half_width) <span class="op">&amp;</span> (w <span class="op">&lt;=</span> lam_center <span class="op">+</span> half_width)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.nonzero(sel)[<span class="dv">0</span>]</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> idx.size <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;No hay canales en </span><span class="sc">{</span>lam_center<span class="sc">:.1f}</span><span class="ss">±</span><span class="sc">{</span>half_width<span class="sc">:.1f}</span><span class="ss"> Å&quot;</span>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> np.zeros((cube.shape[<span class="dv">1</span>], cube.shape[<span class="dv">2</span>]), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> idx:</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        sli <span class="op">=</span> cube.filled_data[i, :, :]       </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        arr <span class="op">=</span> sli.value                     </span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>        np.nan_to_num(arr, copy<span class="op">=</span><span class="va">False</span>, nan<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        img <span class="op">+=</span> arr</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> collapse_window_median(cube, win):</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    w1, w2 <span class="op">=</span> win</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> cube.spectral_axis.to(u.AA).value</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    sel <span class="op">=</span> (w <span class="op">&gt;=</span> w1) <span class="op">&amp;</span> (w <span class="op">&lt;=</span> w2)</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.nonzero(sel)[<span class="dv">0</span>]</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> idx.size <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;No hay canales en ventana continuo </span><span class="sc">{</span>w1<span class="sc">:.1f}</span><span class="ss">-</span><span class="sc">{</span>w2<span class="sc">:.1f}</span><span class="ss"> Å&quot;</span>)</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    stack <span class="op">=</span> []</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> idx:</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>        arr <span class="op">=</span> cube.filled_data[i, :, :].value</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>        stack.append(arr)</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    stack <span class="op">=</span> np.stack(stack, axis<span class="op">=</span><span class="dv">0</span>)         </span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.nanmedian(stack, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>cube_cont  <span class="op">=</span> SpectralCube.read(cube_cont_path,  hdu<span class="op">=</span>hdu_idx)  </span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>cube_lines <span class="op">=</span> SpectralCube.read(cube_lines_path, hdu<span class="op">=</span>hdu_idx)  </span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>img_B <span class="op">=</span> collapse_window_median(cube_cont, cont_win)</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>img_G <span class="op">=</span> collapse_window_sum(cube_lines, lam_oiii, half_line)</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>img_R <span class="op">=</span> collapse_window_sum(cube_lines, lam_ha, half_line)</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stretch_asinh(img, pmin<span class="op">=</span><span class="dv">5</span>, pmax<span class="op">=</span><span class="fl">99.7</span>, soft<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>    lo, hi <span class="op">=</span> np.nanpercentile(img, [pmin, pmax])</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> hi <span class="op">&lt;=</span> lo:</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>        hi <span class="op">=</span> lo <span class="op">+</span> (np.nanstd(img) <span class="kw">or</span> <span class="fl">1.0</span>)</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.clip((img <span class="op">-</span> lo) <span class="op">/</span> (hi <span class="op">-</span> lo), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.arcsinh(x <span class="op">/</span> soft) <span class="op">/</span> np.arcsinh(<span class="dv">1</span><span class="op">/</span>soft)</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>R <span class="op">=</span> stretch_asinh(img_R)</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> stretch_asinh(img_G)</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> stretch_asinh(img_B)</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>rgb <span class="op">=</span> np.dstack([R, G, B])</span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>rgb <span class="op">=</span> np.clip(rgb, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>plt.imshow(rgb, origin<span class="op">=</span><span class="st">&#39;lower&#39;</span>)</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">&#39;off&#39;</span>)</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/239ee2387aaec7d1080dc9276a0916ed37c096da.png" /></p>
</div>
<div class="output stream stdout">
<pre><code>✅ Guardado: rgb_Ha_OIII_continuum.png
</code></pre>
</div>
</div>
<div id="03bc31b4" class="cell code" data-execution_count="25">
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>cube3 <span class="op">=</span> SpectralCube.read(<span class="st">&#39;teacup_continuum_sub.fits&#39;</span>,hdu<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>Hb_cube <span class="op">=</span> fits.<span class="bu">open</span>(<span class="st">&#39;teacup.fits&#39;</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>cube3_sn <span class="op">=</span> SpectralCube(data<span class="op">=</span>Hb_cube[<span class="dv">1</span>].data<span class="op">/</span>np.sqrt(Hb_cube[<span class="dv">2</span>].data),wcs<span class="op">=</span>cube3.wcs)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>cube3_masked <span class="op">=</span> cube3.with_mask(cube3_sn<span class="op">&gt;</span><span class="fl">3.5</span>)</span></code></pre></div>
</div>
<div id="9e1d2ea0" class="cell code" data-execution_count="26">
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>Hb_cube_masked <span class="op">=</span> cube3_masked.with_spectral_unit(u.km<span class="op">/</span>u.s,velocity_convention<span class="op">=</span><span class="st">&#39;optical&#39;</span>,rest_value<span class="op">=</span><span class="fl">5277.03</span><span class="op">*</span>u.AA)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>Hb_subcube_masked <span class="op">=</span> Hb_cube_masked.spectral_slab(<span class="op">-</span><span class="dv">600</span><span class="op">*</span>u.km<span class="op">/</span>u.s,<span class="dv">600</span><span class="op">*</span>u.km<span class="op">/</span>u.s)</span></code></pre></div>
</div>
<div id="31d6bd54" class="cell code" data-execution_count="27">
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>moment_0_masked_Hb <span class="op">=</span> Hb_subcube_masked.moment(order<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>plt.imshow(moment_0_masked_Hb.value, origin<span class="op">=</span><span class="st">&#39;lower&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;inferno&#39;</span>, vmax<span class="op">=</span><span class="fl">1e5</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar()</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>cbar.set_label(<span class="ss">f&quot;Intensity [</span><span class="sc">{</span>moment_0_masked_Hb<span class="sc">.</span>unit<span class="sc">}</span><span class="ss">]&quot;</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;X [pix]&quot;</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Y [pix]&quot;</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;TeaCup Hb - Momento 0&quot;</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/4049017c80fce3ef185f72b9dcf9e1b2068513ec.png" /></p>
</div>
</div>
<div id="1f5d3d85" class="cell code" data-execution_count="28">
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>cube4 <span class="op">=</span> SpectralCube.read(<span class="st">&#39;teacup.fits&#39;</span>,hdu<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Hb_cube = fits.open(&#39;teacup.fits&#39;)</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># cube4_sn = SpectralCube(data=Hb_cube[1].data/np.sqrt(Hb_cube[2].data))</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co"># cube4_masked = cube3.with_mask(cube4_sn&gt;3.5)</span></span></code></pre></div>
</div>
<div id="cfada514" class="cell code" data-execution_count="29">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Hb_cube_masked = cube4_masked.with_spectral_unit(u.km/u.s,velocity_convention=&#39;optical&#39;,rest_value=5277.03*u.AA)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Hb_subcube_masked = Hb_cube_masked.spectral_slab(-600*u.km/u.s,600*u.km/u.s)</span></span></code></pre></div>
</div>
<div id="eecfa9b4" class="cell code" data-execution_count="143">
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>moment_0_masked_Hb_var <span class="op">=</span> cube4.moment(order<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>plt.imshow(moment_0_masked_Hb_var.value, origin<span class="op">=</span><span class="st">&#39;lower&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;inferno&#39;</span>, vmax<span class="op">=</span><span class="fl">1e5</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar()</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>cbar.set_label(<span class="ss">f&quot;Intensity [</span><span class="sc">{</span>moment_0_masked_Hb_var<span class="sc">.</span>unit<span class="sc">}</span><span class="ss">]&quot;</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;X [pix]&quot;</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Y [pix]&quot;</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;TeaCup Hb - Momento 0 - Varianza&quot;</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/68ccefca70a8e141a68f3876172997e678a9f29d.png" /></p>
</div>
</div>
<div id="45a64880" class="cell code" data-execution_count="156">
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>signal <span class="op">=</span> moment_0_masked_Hb.value</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> np.sqrt(moment_0_masked_Hb_var).value</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>sn <span class="op">=</span> signal<span class="op">/</span>noise</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>x,y <span class="op">=</span> np.nonzero(sn<span class="op">&gt;</span><span class="dv">5</span>)</span></code></pre></div>
</div>
<div id="c616fdee" class="cell code" data-execution_count="157">
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>plt.imshow(sn,origin<span class="op">=</span><span class="st">&#39;lower&#39;</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>plt.colorbar()</span></code></pre></div>
<div class="output execute_result" data-execution_count="157">
<pre><code>&lt;matplotlib.colorbar.Colorbar at 0x7f73f18d7580&gt;</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/5729981f8a36af6797279fb902b9478597bc1363.png" /></p>
</div>
</div>
<div id="b46d2b9b" class="cell code" data-execution_count="158">
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>binNum, x_gen, y_gen, x_bar, y_bar, sn, nPixels, scale <span class="op">=</span> voronoi_2d_binning(x, y, signal[x,y], noise[x,y], <span class="dv">650</span>, plot<span class="op">=</span><span class="dv">1</span>, quiet<span class="op">=</span><span class="dv">1</span>,pixelsize<span class="op">=</span><span class="fl">0.2</span>)</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/7c5e0431c0d0e2d61e3a76d03d909ef2d438d5e9.png" /></p>
</div>
</div>
<div id="5badef89" class="cell code" data-execution_count="90">
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>scatter<span class="op">=</span>plt.scatter(x, y, c<span class="op">=</span>binNum, s<span class="op">=</span><span class="dv">2</span>, cmap<span class="op">=</span><span class="st">&#39;viridis&#39;</span>)</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/fe69a0cd7c797c2307201845ab08bace97b1b097.png" /></p>
</div>
</div>
<div id="713d6714" class="cell code" data-execution_count="91">
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(np.unique(binNum))</span></code></pre></div>
<div class="output execute_result" data-execution_count="91">
<pre><code>305</code></pre>
</div>
</div>
<div id="760a5e5e" class="cell code">
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flujo_OIII = []</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Flujo_Hb   = []</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># cube2 = cube.copy()</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co"># for b in np.unique(binNum):</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     x_b = x[binNum == b]</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     y_b = y[binNum == b]</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     if x_b.size == 0:</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         continue</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     cube2.mask[...] = True</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     cube2.mask[:, x_b, y_b] = False</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     spec_bin = cube2.sum(axis=(1, 2))</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     g_oiii = spec_bin.gauss_fit(unit=u.angstrom, lmin=5405.0, lmax=5460.0, plot=False)</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     g_hb   = spec_bin.gauss_fit(unit=u.angstrom, lmin=5265.0, lmax=5290.0, plot=False)</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     F_oiii = float(g_oiii.flux)</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="co">#     F_hb   = float(g_hb.flux)</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     Flujo_OIII.append(F_oiii)</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     Flujo_Hb.append(F_hb)</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Flujo_OIII = np.array(Flujo_OIII)</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Flujo_Hb   = np.array(Flujo_Hb)</span></span></code></pre></div>
</div>
<div id="3be10176" class="cell code">
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="dv">250</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>x_b <span class="op">=</span> x[binNum <span class="op">==</span> b]</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>y_b <span class="op">=</span> y[binNum <span class="op">==</span> b]</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> x_b.size <span class="op">&gt;</span> <span class="dv">0</span>, <span class="ss">f&quot;Bin </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss"> sin spaxels.&quot;</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>cube2 <span class="op">=</span> cube.copy()</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>cube2.mask[...] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>cube2.mask[:, x_b, y_b] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>spec_bin <span class="op">=</span> cube2.<span class="bu">sum</span>(axis<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>w_full <span class="op">=</span> spec_bin.wave.coord()</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>f_full <span class="op">=</span> spec_bin.data</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(lmin, lmax, titulo):</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> spec_bin.gauss_fit(unit<span class="op">=</span>u.angstrom, lmin<span class="op">=</span>lmin, lmax<span class="op">=</span>lmax, plot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> plt.gca()</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> (w_full <span class="op">&gt;=</span> lmin) <span class="op">&amp;</span> (w_full <span class="op">&lt;=</span> lmax)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    ax.plot(w_full[m], f_full[m], <span class="st">&#39;k-&#39;</span>, lw<span class="op">=</span><span class="fl">1.2</span>, label<span class="op">=</span><span class="st">&#39;Espectro&#39;</span>)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">&#39;best&#39;</span>, frameon<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="fl">0.85</span>)</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f&quot;</span><span class="sc">{</span>titulo<span class="sc">}</span><span class="ss"> — bin </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;λ [Å]&quot;</span>)</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Flujo&quot;</span>)</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> <span class="bu">float</span>(<span class="bu">getattr</span>(g, <span class="st">&#39;flux&#39;</span>, np.nan))</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> F</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>F_hb <span class="op">=</span> fit(<span class="fl">5265.0</span>, <span class="fl">5290.0</span>, <span class="vs">r&#39;H$\beta$&#39;</span>)</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>F_o3 <span class="op">=</span> fit(<span class="fl">5405.0</span>, <span class="fl">5460.0</span>, <span class="vs">r&#39;[O III] 5007&#39;</span>)</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;bin </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">:  F(Hβ) = </span><span class="sc">{</span>F_hb<span class="sc">:.3g}</span><span class="ss">,   F([O III]) = </span><span class="sc">{</span>F_o3<span class="sc">:.3g}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/dc3c955cf0c53b5950714a78d4a7ff42d71429af.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/eb65b5c20eb6b672ca7e092d1ec5215da6a724cc.png" /></p>
</div>
<div class="output stream stdout">
<pre><code>bin 250:  F(Hβ) = 1.7e+04,   F([O III]) = 1.05e+05
</code></pre>
</div>
</div>
<div id="fcca1d92" class="cell code">
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> two_gauss(w, Aha, muha, Ani, muni, sigma):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (Aha<span class="op">*</span>np.exp(<span class="op">-</span>(w<span class="op">-</span>muha)<span class="op">**</span><span class="dv">2</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>sigma<span class="op">**</span><span class="dv">2</span>)) <span class="op">+</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>            Ani<span class="op">*</span>np.exp(<span class="op">-</span>(w<span class="op">-</span>muni)<span class="op">**</span><span class="dv">2</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>sigma<span class="op">**</span><span class="dv">2</span>)))</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>WMIN, WMAX <span class="op">=</span> <span class="fl">7085.0</span>, <span class="fl">7170.0</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>p0 <span class="op">=</span> [<span class="dv">15000</span>, <span class="fl">7122.0</span>, <span class="dv">6000</span>, <span class="fl">7145.0</span>, <span class="fl">2.5</span>]</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>bounds <span class="op">=</span> (</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">0</span>, <span class="fl">7115.0</span>, <span class="dv">0</span>, <span class="fl">7135.0</span>, <span class="fl">0.6</span>],</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    [np.inf, <span class="fl">7128.0</span>, np.inf, <span class="fl">7155.0</span>, <span class="fl">8.0</span>]</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>Flux_Ha  <span class="op">=</span> []</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>Flux_NII <span class="op">=</span> []</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>cube2 <span class="op">=</span> cube.copy()</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b <span class="kw">in</span> np.unique(binNum):</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    x_b <span class="op">=</span> x[binNum <span class="op">==</span> b]</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    y_b <span class="op">=</span> y[binNum <span class="op">==</span> b]</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x_b.size <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>    cube2.mask[...] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    cube2.mask[:, x_b, y_b] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>    spec_bin <span class="op">=</span> cube2.<span class="bu">sum</span>(axis<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> spec_bin.wave.coord()</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> spec_bin.data</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> (w <span class="op">&gt;=</span> WMIN) <span class="op">&amp;</span> (w <span class="op">&lt;=</span> WMAX)</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>    w, f <span class="op">=</span> w[m], f[m]</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>    popt, _ <span class="op">=</span> curve_fit(two_gauss, w, f, p0<span class="op">=</span>p0, bounds<span class="op">=</span>bounds, maxfev<span class="op">=</span><span class="dv">20000</span>)</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>    Aha, muha, Ani, muni, sigma <span class="op">=</span> popt</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    Fha  <span class="op">=</span> Aha <span class="op">*</span> sigma <span class="op">*</span> math.sqrt(<span class="dv">2</span><span class="op">*</span>np.pi)</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    Fnii <span class="op">=</span> Ani <span class="op">*</span> sigma <span class="op">*</span> math.sqrt(<span class="dv">2</span><span class="op">*</span>np.pi)</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>    Flux_Ha.append(Fha)</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>    Flux_NII.append(Fnii)</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> b <span class="op">%</span> <span class="dv">50</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>        ft <span class="op">=</span> two_gauss(w, <span class="op">*</span>popt)</span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>        plt.plot(w, f, <span class="st">&#39;k&#39;</span>, lw<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">&#39;Espectro bin </span><span class="sc">%d</span><span class="st">&#39;</span> <span class="op">%</span> b)</span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>        plt.plot(w, ft, <span class="st">&#39;r-&#39;</span>, lw<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">&#39;Ajuste total&#39;</span>)</span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>        plt.plot(w, Aha<span class="op">*</span>np.exp(<span class="op">-</span>(w<span class="op">-</span>muha)<span class="op">**</span><span class="dv">2</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>sigma<span class="op">**</span><span class="dv">2</span>)), <span class="st">&#39;g--&#39;</span>, label<span class="op">=</span><span class="st">&#39;Hα&#39;</span>)</span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>        plt.plot(w, Ani<span class="op">*</span>np.exp(<span class="op">-</span>(w<span class="op">-</span>muni)<span class="op">**</span><span class="dv">2</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>sigma<span class="op">**</span><span class="dv">2</span>)), <span class="st">&#39;b--&#39;</span>, label<span class="op">=</span><span class="st">&#39;[N II]&#39;</span>)</span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">&quot;λ [Å]&quot;</span>)</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">&quot;Flujo&quot;</span>)</span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>        plt.legend()</span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>Flux_Ha  <span class="op">=</span> np.array(Flux_Ha)</span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>Flux_NII <span class="op">=</span> np.array(Flux_NII)</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/8afa41a3af692e1fc4f2931f5e1573a1a80fd2c2.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/08c95d4c355cc1ba7ae37b2a5d989580c147719c.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/eb26a59ad91da9ad04b9e5e105f39217cd9b9d3a.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/2118253f4d921116045161f4a9a245b1a15fbf81.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/ffb625c6bbaba5ce3ced187815043a5a478193a7.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/a15771c37c53e405055f8dec28105f369a0953a5.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/40392a4ae30211acff8591eff413aacac407fd6e.png" /></p>
</div>
</div>
<div id="1092ebe5" class="cell code">
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&quot;flujos_por_bin.csv&quot;</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>bins <span class="op">=</span> df[<span class="st">&quot;bin&quot;</span>].to_numpy(<span class="bu">int</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>nbins <span class="op">=</span> bins.<span class="bu">max</span>() <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>Flux_Ha <span class="op">=</span> np.full(nbins, np.nan, <span class="bu">float</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>Flux_Hb <span class="op">=</span> np.full(nbins, np.nan, <span class="bu">float</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>Flux_Ha[bins] <span class="op">=</span> df[<span class="st">&quot;Flux_Ha&quot;</span>].to_numpy(<span class="bu">float</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>Flux_Hb[bins] <span class="op">=</span> df[<span class="st">&quot;Flux_Hb&quot;</span>].to_numpy(<span class="bu">float</span>)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>ratio <span class="op">=</span> Flux_Ha <span class="op">/</span> Flux_Hb</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>ny, nx <span class="op">=</span> cube.shape[<span class="dv">1</span>], cube.shape[<span class="dv">2</span>]</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>map_ratio <span class="op">=</span> np.full((ny, nx), np.nan, <span class="bu">float</span>)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>map_ratio[y, x] <span class="op">=</span> ratio[binNum]</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    wcs2d <span class="op">=</span> cube2.wcs.celestial</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    hdr <span class="op">=</span> fits.getheader(<span class="st">&quot;teacup_continuum_sub.fits&quot;</span>, <span class="dv">1</span>)  </span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    wcs2d <span class="op">=</span> WCS(hdr).celestial</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>vals <span class="op">=</span> map_ratio[np.isfinite(map_ratio)]</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>vmin, vmax <span class="op">=</span> np.nanpercentile(vals, [<span class="dv">2</span>, <span class="dv">98</span>]) <span class="cf">if</span> vals.size <span class="cf">else</span> (<span class="fl">1.5</span>, <span class="fl">5.0</span>)</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> vmax <span class="op">&lt;=</span> vmin:</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    vmax <span class="op">=</span> vmin <span class="op">+</span> (np.nanstd(vals) <span class="kw">or</span> <span class="fl">1.0</span>)</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">6</span>))</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.subplot(projection<span class="op">=</span>wcs2d)</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> ax.imshow(map_ratio, origin<span class="op">=</span><span class="st">&#39;lower&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;inferno&#39;</span>, vmin<span class="op">=</span>vmin, vmax<span class="op">=</span>vmax)</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar(im, ax<span class="op">=</span>ax, pad<span class="op">=</span><span class="fl">0.02</span>)</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>cbar.ax.yaxis.set_major_formatter(ScalarFormatter(useMathText<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>cbar.set_label(<span class="vs">r&#39;H$\alpha$/H$\beta$&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">&#39;Ascensión Recta&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;Declinación&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="vs">r&#39;Decremento de Balmer&#39;</span>, fontsize<span class="op">=</span><span class="dv">14</span>, pad<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>ax.invert_xaxis()</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>ax.coords.grid(color<span class="op">=</span><span class="st">&#39;gray&#39;</span>, ls<span class="op">=</span><span class="st">&#39;:&#39;</span>, lw<span class="op">=</span><span class="fl">0.4</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/b90535c794cb1da6721d282710e67983f8f4c4ad.png" /></p>
</div>
</div>
<div id="c2536e0e" class="cell code">
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&quot;flujos_por_bin_corrected.csv&quot;</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>bins <span class="op">=</span> df[<span class="st">&quot;bin&quot;</span>].astype(<span class="bu">int</span>).to_numpy()</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.log10(df[<span class="st">&quot;NII_corr&quot;</span>] <span class="op">/</span> df[<span class="st">&quot;Ha_corr&quot;</span>])</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.log10(df[<span class="st">&quot;OIII_corr&quot;</span>] <span class="op">/</span> df[<span class="st">&quot;Hb_corr&quot;</span>]) </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bpt_classify(xi, yi):</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> np.isfinite(xi) <span class="kw">or</span> <span class="kw">not</span> np.isfinite(yi):</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;NaN&quot;</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    kauff  <span class="op">=</span> <span class="fl">0.61</span><span class="op">/</span>(xi <span class="op">-</span> <span class="fl">0.05</span>) <span class="op">+</span> <span class="fl">1.3</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    kewley <span class="op">=</span> <span class="fl">0.61</span><span class="op">/</span>(xi <span class="op">-</span> <span class="fl">0.47</span>) <span class="op">+</span> <span class="fl">1.19</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> yi <span class="op">&gt;</span> kewley:</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;Seyfert&quot;</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> yi <span class="op">&gt;</span> kauff:</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;Composite&quot;</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;SF&quot;</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;BPT_class&quot;</span>] <span class="op">=</span> [bpt_classify(xi, yi) <span class="cf">for</span> xi, yi <span class="kw">in</span> <span class="bu">zip</span>(x, y)]</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">&quot;flujos_por_bin_BPT.csv&quot;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>OK: columna BPT_class agregada
</code></pre>
</div>
</div>
<div id="ad631677" class="cell code">
<div class="sourceCode" id="cb55"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&quot;flujos_por_bin.csv&quot;</span>).astype(<span class="bu">float</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>HAB_HB_teor <span class="op">=</span> <span class="fl">2.86</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>kHb <span class="op">=</span> extinction.calzetti00(np.array([<span class="fl">4861.0</span>]), <span class="fl">1.0</span>, <span class="fl">4.05</span>)[<span class="dv">0</span>]</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>kHa <span class="op">=</span> extinction.calzetti00(np.array([<span class="fl">6563.0</span>]), <span class="fl">1.0</span>, <span class="fl">4.05</span>)[<span class="dv">0</span>]</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>kO3 <span class="op">=</span> extinction.calzetti00(np.array([<span class="fl">5007.0</span>]), <span class="fl">1.0</span>, <span class="fl">4.05</span>)[<span class="dv">0</span>]</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>kN2 <span class="op">=</span> extinction.calzetti00(np.array([<span class="fl">6583.0</span>]), <span class="fl">1.0</span>, <span class="fl">4.05</span>)[<span class="dv">0</span>]</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>ratio_obs <span class="op">=</span> (df[<span class="st">&quot;Flux_Ha&quot;</span>] <span class="op">/</span> df[<span class="st">&quot;Flux_Hb&quot;</span>]).replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>ratio_obs <span class="op">=</span> ratio_obs.where(ratio_obs <span class="op">&gt;</span> <span class="dv">0</span>) </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>EBV <span class="op">=</span> (<span class="fl">2.5</span> <span class="op">/</span> (kHb <span class="op">-</span> kHa)) <span class="op">*</span> np.log10(ratio_obs <span class="op">/</span> HAB_HB_teor)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corr_factor(k, ebv): </span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.power(<span class="fl">10.0</span>, <span class="fl">0.4</span> <span class="op">*</span> k <span class="op">*</span> ebv)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>Ha   <span class="op">=</span> df[<span class="st">&quot;Flux_Ha&quot;</span>]   <span class="op">*</span> corr_factor(kHa, EBV)</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>Hb   <span class="op">=</span> df[<span class="st">&quot;Flux_Hb&quot;</span>]   <span class="op">*</span> corr_factor(kHb, EBV)</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>OIII <span class="op">=</span> df[<span class="st">&quot;Flux_OIII&quot;</span>] <span class="op">*</span> corr_factor(kO3, EBV)</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>NII  <span class="op">=</span> df[<span class="st">&quot;Flux_NII&quot;</span>]  <span class="op">*</span> corr_factor(kN2, EBV)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.log10(NII <span class="op">/</span> Ha)</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.log10(OIII <span class="op">/</span> Hb)</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>finite <span class="op">=</span> np.isfinite(x) <span class="op">&amp;</span> np.isfinite(y)</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>xx <span class="op">=</span> np.linspace(<span class="op">-</span><span class="fl">2.0</span>, <span class="fl">0.5</span>, <span class="dv">600</span>)</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>kauff03 <span class="op">=</span> <span class="fl">0.61</span><span class="op">/</span>(xx <span class="op">-</span> <span class="fl">0.05</span>) <span class="op">+</span> <span class="fl">1.3</span>      <span class="co"># Kauffmann (2003): límite empírico SF</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>kewley01 <span class="op">=</span> <span class="fl">0.61</span><span class="op">/</span>(xx <span class="op">-</span> <span class="fl">0.47</span>) <span class="op">+</span> <span class="fl">1.19</span>    <span class="co"># Kewley (2001): límite teórico SF</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="fl">6.4</span>, <span class="fl">5.2</span>))</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>plt.plot(xx, kauff03, <span class="st">&#39;--&#39;</span>, lw<span class="op">=</span><span class="fl">1.6</span>, color<span class="op">=</span><span class="st">&#39;#1f77b4&#39;</span>, label<span class="op">=</span><span class="st">&#39;Kauffmann 2003&#39;</span>)</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>plt.plot(xx, kewley01, <span class="st">&#39;-&#39;</span>,  lw<span class="op">=</span><span class="fl">1.6</span>, color<span class="op">=</span><span class="st">&#39;#d62728&#39;</span>, label<span class="op">=</span><span class="st">&#39;Kewley 2001&#39;</span>)</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>sc <span class="op">=</span> plt.scatter(x[finite], y[finite], c<span class="op">=</span>EBV[finite], s<span class="op">=</span><span class="dv">18</span>, cmap<span class="op">=</span><span class="st">&#39;viridis&#39;</span>, edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>)</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>cbar <span class="op">=</span> plt.colorbar(sc)<span class="op">;</span> cbar.set_label(<span class="vs">r&#39;$E(B-V)$ (Calzetti 2000)&#39;</span>)</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="op">-</span><span class="fl">2.0</span>, <span class="fl">0.5</span>)</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="vs">r&#39;$\log_</span><span class="sc">{10}</span><span class="vs">\,([\mathrm{N\,II}]\,6583/\mathrm</span><span class="sc">{H}</span><span class="vs">\alpha)$&#39;</span>)</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="vs">r&#39;$\log_</span><span class="sc">{10}</span><span class="vs">\,([\mathrm{O\,III}]\,5007/\mathrm</span><span class="sc">{H}</span><span class="vs">\beta)$&#39;</span>)</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>plt.grid(alpha<span class="op">=</span><span class="fl">0.25</span>, ls<span class="op">=</span><span class="st">&#39;:&#39;</span>)</span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">&#39;lower left&#39;</span>)</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_a73acd2335ac48038adfd5f47f2893b9/aa5185f3e10272ed520946d3e3cc51386d5ea3bf.png" /></p>
</div>
</div>
<div id="4aa1a00e" class="cell code" data-execution_count="152">
<div class="sourceCode" id="cb56"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>z_sys <span class="op">=</span> <span class="fl">0.08571</span>  </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">&quot;flujos_por_bin_corrected.csv&quot;</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>dL <span class="op">=</span> cosmo.luminosity_distance(z_sys).to(u.cm).value  </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>fac <span class="op">=</span> <span class="fl">4.0</span> <span class="op">*</span> np.pi <span class="op">*</span> dL<span class="op">**</span><span class="dv">2</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;L_Ha&quot;</span>]   <span class="op">=</span> fac <span class="op">*</span> df[<span class="st">&quot;Ha_corr&quot;</span>].to_numpy()</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;L_Hb&quot;</span>]   <span class="op">=</span> fac <span class="op">*</span> df[<span class="st">&quot;Hb_corr&quot;</span>].to_numpy()</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;L_OIII&quot;</span>] <span class="op">=</span> fac <span class="op">*</span> df[<span class="st">&quot;OIII_corr&quot;</span>].to_numpy()</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;L_NII&quot;</span>]  <span class="op">=</span> fac <span class="op">*</span> df[<span class="st">&quot;NII_corr&quot;</span>].to_numpy()</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;log_NII_Ha&quot;</span>]  <span class="op">=</span> np.log10(df[<span class="st">&quot;L_NII&quot;</span>]  <span class="op">/</span> df[<span class="st">&quot;L_Ha&quot;</span>])</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;log_OIII_Hb&quot;</span>] <span class="op">=</span> np.log10(df[<span class="st">&quot;L_OIII&quot;</span>] <span class="op">/</span> df[<span class="st">&quot;L_Hb&quot;</span>])</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">&quot;flujos_y_luminosidades_por_bin.csv&quot;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
</div>
</body>
</html>
